# Dream Forge — Masters Document 6: Data Model

Last updated: 2025-09-12

Status: Draft for review

Owners: Engineering (Architecture), Data (Schema), DX (Contracts)

References: docs/masters/01-introduction-vision-goals.md, docs/masters/02-principles-of-system-design.md, docs/masters/03-requirements.md, docs/masters/04-architecture-overview.md, docs/masters/05-systems-components-modules.md

---

## 1) Purpose & Scope

Define the relational schema, entity contracts, relationships, constraints, and indexes for the MVP (with forward hooks for Beta). The model supports jobs, steps, events, artifacts, and the model registry. It balances normalization with JSON fields for flexible payloads.

---

## 2) Conventions & Types

- IDs: UUID (`uuid` in Postgres), generated by app (`uuid4`) or `gen_random_uuid()`.
- Timestamps: `timestamptz` (`created_at`, `updated_at`), default `now()`; app updates `updated_at`.
- JSON: `jsonb` for flexible payloads (params, metadata, schema, files list).
- Status fields: text with CHECK constraints (no custom enum type to keep migrations simple).
- Partial indexes: used for optional uniqueness (e.g., idempotency key when present).
- Versioning: `schema_version` (smallint) on core tables to allow additive evolution.

---

## 3) Entities & Fields

### 3.1 jobs

Purpose: Top-level unit representing a user request (e.g., generate images). Supports batch count and idempotency.

Fields (summary):

- `id uuid PK`
- `type text NOT NULL` — CHECK in {`generate`, `model_download`(reserved)}
- `status text NOT NULL` — CHECK in {`queued`, `running`, `succeeded`, `failed`}
- `params_json jsonb NOT NULL` — input parameters (includes `prompt`, sizing, etc.). May include `count` (1..100), `model_id`.
- `schema_version smallint NOT NULL DEFAULT 1`
- `idempotency_key_hash bytea NULL` — SHA‑256 of client header; optional
- `error_code text NULL`, `error_message text NULL` — terminal error info
- `created_at timestamptz NOT NULL DEFAULT now()`
- `updated_at timestamptz NOT NULL DEFAULT now()`

Indexes/constraints:

- PK on `id`
- CHECK `status` in allowed set; CHECK `type` in allowed set
- Unique partial index on `idempotency_key_hash` WHERE `idempotency_key_hash IS NOT NULL`
- Index on `updated_at`, `status`

Notes:

- Idempotency key is hashed to constant size; raw value never stored.
- Batch `count` is stored in `params_json`. Enforcement (≤100) occurs at API layer; may add DB CHECK in a later version.

---

### 3.2 steps

Purpose: Child unit within a job (e.g., `generate`). Enables multi-step chaining later.

Fields:

- `id uuid PK`
- `job_id uuid NOT NULL FK jobs(id)`
- `name text NOT NULL` — e.g., `generate`
- `status text NOT NULL` — CHECK in {`queued`, `running`, `succeeded`, `failed`}
- `started_at timestamptz NULL`
- `finished_at timestamptz NULL`
- `metadata_json jsonb NOT NULL DEFAULT '{}'::jsonb` — resolved params, preset details, device info
- `schema_version smallint NOT NULL DEFAULT 1`
- `created_at timestamptz NOT NULL DEFAULT now()`
- `updated_at timestamptz NOT NULL DEFAULT now()`

Indexes/constraints:

- PK on `id`
- FK (`job_id`) ON DELETE CASCADE
- Index on (`job_id`, `created_at`)

---

### 3.3 events

Purpose: Append-only log of job/step execution for status, progress, logs, and metrics. Drives `/logs`, `/progress`, and SSE.

Fields:

- `id uuid PK`
- `job_id uuid NOT NULL FK jobs(id)`
- `step_id uuid NULL FK steps(id)` — NULL for job-level events
- `ts timestamptz NOT NULL DEFAULT now()`
- `code text NOT NULL` — e.g., `job.start`, `step.start`, `progress`, `artifact.written`, `gpu.mem`, `error`, `step.finish`, `job.finish`
- `level text NOT NULL DEFAULT 'info'` — CHECK in {`debug`, `info`, `warn`, `error`}
- `payload_json jsonb NOT NULL DEFAULT '{}'::jsonb` — structured payload (see 4.2)

Indexes/constraints:

- PK on `id`
- FK (`job_id`) ON DELETE CASCADE; FK (`step_id`) ON DELETE CASCADE
- Index on (`job_id`, `ts DESC`)
- Optional partial index for tails: (`job_id`) WHERE `ts > now() - interval '10 minutes'`

---

### 3.4 artifacts

Purpose: Metadata index for produced files in object storage with batch awareness.

Fields:

- `id uuid PK`
- `job_id uuid NOT NULL FK jobs(id)`
- `step_id uuid NOT NULL FK steps(id)`
- `created_at timestamptz NOT NULL DEFAULT now()`
- `format text NOT NULL` — CHECK in {`png`, `jpg`}
- `width int NOT NULL`, `height int NOT NULL` — CHECK > 0
- `seed bigint NULL` — per-item seed used; NULL if not applicable
- `item_index int NOT NULL DEFAULT 0` — 0-based batch index
- `s3_key text NOT NULL` — object key
- `checksum text NULL` — optional sha256 of content
- `metadata_json jsonb NOT NULL DEFAULT '{}'::jsonb` — embedded fields summary, additional tags
- `schema_version smallint NOT NULL DEFAULT 1`

Indexes/constraints:

- PK on `id`
- FK (`job_id`) ON DELETE CASCADE; FK (`step_id`) ON DELETE CASCADE
- Unique on (`job_id`, `step_id`, `item_index`) — ensures one primary artifact per item
- Index on (`job_id`)

---

### 3.5 models (registry)

Purpose: Registry of available models/providers with descriptors and schemas for parameters.

Fields:

- `id uuid PK`
- `name text NOT NULL`
- `kind text NOT NULL` — e.g., `sdxl-checkpoint`, `remote-api`
- `version text NULL`
- `checkpoint_hash text NULL` — when applicable
- `source_uri text NULL` — e.g., `hf:repo@rev#file`, `civitai:model@ver`
- `local_path text NULL` — normalized install root (if installed locally)
- `installed boolean NOT NULL DEFAULT false`
- `enabled boolean NOT NULL DEFAULT true`
- `parameters_schema jsonb NOT NULL DEFAULT '{}'::jsonb` — JSON Schema for request params
- `capabilities jsonb NOT NULL DEFAULT '[]'::jsonb` — list of supported job types
- `files_json jsonb NOT NULL DEFAULT '[]'::jsonb` — array of `{path, sha256, size}` entries
- `created_at timestamptz NOT NULL DEFAULT now()`
- `updated_at timestamptz NOT NULL DEFAULT now()`

Indexes/constraints:

- PK on `id`
- Unique partial index on (`name`, `version`, `kind`) WHERE `version IS NOT NULL`
- Index on (`enabled`, `installed`)
- Index on (`source_uri`)

Notes:

- Using `files_json` avoids a second table in MVP; can be normalized later if needed.
- `parameters_schema` enables UI-driven parameter forms and validation.

---

## 4) Contracts & Payloads

### 4.1 jobs.params_json (generate)

Shape (illustrative):

```
{
  "type": "generate",
  "prompt": "an old-growth forest at dawn",
  "negative_prompt": "",
  "width": 1024,
  "height": 1024,
  "steps": 30,
  "guidance": 7.0,
  "scheduler": "dpmpp_2m_karras",
  "format": "png",
  "embed_metadata": true,
  "count": 8,
  "model_id": "<uuid>"
}
```

Validation: `count` in [1,100]; `format` in {png,jpg}; sizes/presets validated by API.

### 4.2 events.payload_json

- `progress`: `{ "value": 0.0..1.0, "stage": "sampling", "item_index": 0 }`
- `artifact.written`: `{ "s3_key": "...", "format": "png", "width": 1024, "height": 1024, "seed": 123456789, "item_index": 0 }`
- `gpu.mem`: `{ "before": 12345678, "after": 2345678, "peak": 16777216 }` (bytes)
- `error`: `{ "code": "oom", "message": "Out of memory", "details": { ... }, "item_index": 0 }`
- `step.start` / `step.finish`: may include preset/device snapshot and counts

### 4.3 artifacts.metadata_json (embedded)

Copy of embedded metadata fields for searchability (prompt, negative_prompt, seed, scheduler, steps, guidance, checkpoint hash, etc.).

### 4.4 models.parameters_schema (JSON Schema)

Defines required/optional parameters, numeric ranges, enums (e.g., schedulers), defaults. Example excerpt:

```
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "type": "object",
  "properties": {
    "width": { "type": "integer", "minimum": 64, "maximum": 2048, "default": 1024 },
    "height": { "type": "integer", "minimum": 64, "maximum": 2048, "default": 1024 },
    "steps": { "type": "integer", "minimum": 1, "maximum": 200, "default": 30 },
    "scheduler": { "type": "string", "enum": ["dpmpp_2m_karras", "unipc"], "default": "dpmpp_2m_karras" }
  },
  "required": ["width", "height", "steps"]
}
```

---

## 5) Relationships & ER Sketch (text)

- Job (1) — (N) Step
- Step (1) — (N) Event
- Step (1) — (N) Artifact
- Job (1) — (N) Artifact (denormalized FK for quick listing)
- Model is independent; referenced by `jobs.params_json.model_id`

Batch semantics:

- Artifacts and events carry `item_index` (0..count‑1). Unique constraint on (`job_id`,`step_id`,`item_index`) ensures one primary artifact per item.

---

## 6) Example DDL (Postgres)

Note: Illustrative; final DDL lives in Alembic migrations.

```
-- jobs
CREATE TABLE jobs (
  id uuid PRIMARY KEY,
  type text NOT NULL CHECK (type IN ('generate','model_download')),
  status text NOT NULL CHECK (status IN ('queued','running','succeeded','failed')),
  params_json jsonb NOT NULL,
  schema_version smallint NOT NULL DEFAULT 1,
  idempotency_key_hash bytea NULL,
  error_code text NULL,
  error_message text NULL,
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now()
);
CREATE UNIQUE INDEX jobs_idempo_uniq ON jobs(idempotency_key_hash) WHERE idempotency_key_hash IS NOT NULL;
CREATE INDEX jobs_updated_idx ON jobs(updated_at);
CREATE INDEX jobs_status_idx ON jobs(status);

-- steps
CREATE TABLE steps (
  id uuid PRIMARY KEY,
  job_id uuid NOT NULL REFERENCES jobs(id) ON DELETE CASCADE,
  name text NOT NULL,
  status text NOT NULL CHECK (status IN ('queued','running','succeeded','failed')),
  started_at timestamptz NULL,
  finished_at timestamptz NULL,
  metadata_json jsonb NOT NULL DEFAULT '{}'::jsonb,
  schema_version smallint NOT NULL DEFAULT 1,
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now()
);
CREATE INDEX steps_job_created_idx ON steps(job_id, created_at);

-- events
CREATE TABLE events (
  id uuid PRIMARY KEY,
  job_id uuid NOT NULL REFERENCES jobs(id) ON DELETE CASCADE,
  step_id uuid NULL REFERENCES steps(id) ON DELETE CASCADE,
  ts timestamptz NOT NULL DEFAULT now(),
  code text NOT NULL,
  level text NOT NULL DEFAULT 'info' CHECK (level IN ('debug','info','warn','error')),
  payload_json jsonb NOT NULL DEFAULT '{}'::jsonb
);
CREATE INDEX events_job_ts_desc_idx ON events(job_id, ts DESC);

-- artifacts
CREATE TABLE artifacts (
  id uuid PRIMARY KEY,
  job_id uuid NOT NULL REFERENCES jobs(id) ON DELETE CASCADE,
  step_id uuid NOT NULL REFERENCES steps(id) ON DELETE CASCADE,
  created_at timestamptz NOT NULL DEFAULT now(),
  format text NOT NULL CHECK (format IN ('png','jpg')),
  width int NOT NULL CHECK (width > 0),
  height int NOT NULL CHECK (height > 0),
  seed bigint NULL,
  item_index int NOT NULL DEFAULT 0,
  s3_key text NOT NULL,
  checksum text NULL,
  metadata_json jsonb NOT NULL DEFAULT '{}'::jsonb,
  schema_version smallint NOT NULL DEFAULT 1
);
CREATE UNIQUE INDEX artifacts_job_step_item_uniq ON artifacts(job_id, step_id, item_index);
CREATE INDEX artifacts_job_idx ON artifacts(job_id);

-- models
CREATE TABLE models (
  id uuid PRIMARY KEY,
  name text NOT NULL,
  kind text NOT NULL,
  version text NULL,
  checkpoint_hash text NULL,
  source_uri text NULL,
  local_path text NULL,
  installed boolean NOT NULL DEFAULT false,
  enabled boolean NOT NULL DEFAULT true,
  parameters_schema jsonb NOT NULL DEFAULT '{}'::jsonb,
  capabilities jsonb NOT NULL DEFAULT '[]'::jsonb,
  files_json jsonb NOT NULL DEFAULT '[]'::jsonb,
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now()
);
CREATE UNIQUE INDEX models_name_ver_kind_uniq ON models(name, version, kind) WHERE version IS NOT NULL;
CREATE INDEX models_enabled_installed_idx ON models(enabled, installed);
CREATE INDEX models_source_uri_idx ON models(source_uri);
```

---

## 7) Typical Queries

- List artifacts for a job: `SELECT * FROM artifacts WHERE job_id=$1 ORDER BY item_index;`
- Tail events for SSE: `SELECT * FROM events WHERE job_id=$1 AND ts > $2 ORDER BY ts ASC LIMIT $3;`
- Compute progress (server-side draft): sum latest per-item progress / count of items.
- List models: `SELECT id,name,kind,version,installed,enabled,parameters_schema FROM models WHERE enabled=true ORDER BY name;`

---

## 8) Data Retention & Cleanup

- Dev defaults: MinIO bucket TTL ~24h. DB retention: keep jobs/events/artifacts until manual prune in MVP.
- Future: add retention policy columns (e.g., `retention_days`) or housekeeping jobs; expose admin endpoints.

---

## 9) Evolution Notes

- Add `job_children` table for chaining; keep Steps minimal for now.
- Normalize `models.files_json` to a `model_files` table if querying files becomes frequent.
- Add `job_metrics` materialized view if progress queries require aggregation at scale.
- Add `fail_reason` structured column(s) if error taxonomy expands.

---

## 10) Change Log & Links

- 2025-09-12: Initial draft of relational schema with batch and model registry support.

Related:

- Masters Doc 1: docs/masters/01-introduction-vision-goals.md
- Masters Doc 2: docs/masters/02-principles-of-system-design.md
- Masters Doc 3: docs/masters/03-requirements.md
- Masters Doc 4: docs/masters/04-architecture-overview.md
- Masters Doc 5: docs/masters/05-systems-components-modules.md

